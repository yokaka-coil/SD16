<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ•£æ­©å®ç®± MINI v2.1ï¼ˆæ¨©é™&è¡¨ç¤ºå®‰å®šï¼‰</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    /* ãƒœã‚¿ãƒ³ãŒãƒãƒƒãƒ—ã«éš ã‚Œãªã„ã‚ˆã†ã« z-index ã‚’å¼·ã‚ã‚‹ */
    .fab {
      position: fixed; right: 16px; top: 16px;
      background: #2d6cdf; color: #fff; border: 0; border-radius: 999px;
      padding: 12px 16px; font-size: 16px; box-shadow: 0 4px 14px rgba(0,0,0,.25);
      z-index: 2000;
    }
    .toast {
      position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
      background: rgba(0,0,0,.85); color: #fff; padding: 10px 14px; border-radius: 8px;
      font-size: 14px; display:none; cursor: pointer; z-index: 2000;
    }
    .banner {
      position: fixed; left: 50%; top: 8px; transform: translateX(-50%);
      background: #fffae6; color: #444; border: 1px solid #e0c96f;
      padding: 8px 12px; border-radius: 8px; font-size: 13px; z-index: 2100; display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="banner" id="banner"></div>
  <button class="fab" id="addBtn" type="button">ï¼‹ å®ç®±</button>
  <div class="toast" id="toast" title="ã‚¿ãƒƒãƒ—ã§é–‹ã">è¿‘ãã«å®ç®±ãŒã‚ã‚Šã¾ã™ ğŸ“¦</div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // ===== UI helpers =====
    const banner = (msg) => {
      const b = document.getElementById('banner');
      b.textContent = msg; b.style.display = 'block';
      clearTimeout(b._t);
      b._t = setTimeout(()=> b.style.display='none', 5000);
    };
    const toastEl = document.getElementById('toast');
    const toast = (msg, ms=1800) => {
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toastEl.style.display='none', ms);
    };
    const vibrate = pat => navigator.vibrate && navigator.vibrate(pat);

    // ===== local storage helpers =====
    const LS = { get:(k,d)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d)), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
    const UID_KEY='userId', CAPS_KEY='capsules', OPEN_KEY='openEvents', REPORT_KEY='reports';
    const getUid=()=>{ let u=localStorage.getItem(UID_KEY); if(!u){u='u_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6); localStorage.setItem(UID_KEY,u);} return u; };
    const loadCapsules=()=>LS.get(CAPS_KEY,[]), saveCapsules=a=>LS.set(CAPS_KEY,a);
    const loadOpens=()=>LS.get(OPEN_KEY,[]), saveOpens=a=>LS.set(OPEN_KEY,a);
    const loadReports=()=>LS.get(REPORT_KEY,[]), saveReports=a=>LS.set(REPORT_KEY,a);

    // ===== distance =====
    const distM=(a,b)=>{const R=6371000,toRad=d=>d*Math.PI/180,dLat=toRad(b.lat-a.lat),dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
      const aa=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(aa));
    };

    // ===== map init =====
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
    map.setView([35.6812,139.7671], 14); // ä»®ã«æ±äº¬é§…
    // ã‚µã‚¤ã‚ºå®‰å®šï¼ˆã¨ãã©ãåœ°å›³ãŒç¸®ã‚€å•é¡Œå¯¾ç­–ï¼‰
    setTimeout(()=> map.invalidateSize(), 200);
    window.addEventListener('resize', ()=> map.invalidateSize());

    // æ¨©é™ï¼†å®Ÿè¡Œç’°å¢ƒãƒã‚§ãƒƒã‚¯
    if (!location.hostname.includes('localhost') && location.protocol !== 'https:') {
      banner('ä½ç½®æƒ…å ±ã¯ HTTPS ã‹ localhost ã§ãªã„ã¨å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¯èƒ½ãªã‚‰ http://localhost:8000 ã§é–‹ã„ã¦ãã ã•ã„ã€‚');
    }

    // geolocation åˆæœŸä½ç½®
    function explainGeoError(err){
      if (err.code===1) banner('ä½ç½®æƒ…å ±ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µã‚¤ãƒˆã®æ¨©é™ã‹ã‚‰ã€Œä½ç½®æƒ…å ±ã‚’è¨±å¯ã€ã«ã—ã¦ãã ã•ã„ã€‚');
      else if (err.code===2) banner('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ï¼ˆç«¯æœ«ã®ä½ç½®æƒ…å ±è¨­å®šã‚’ç¢ºèªï¼‰ã€‚');
      else banner('ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
      console.warn('geo error', err);
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat, longitude:lng}=pos.coords;
      map.setView([lat,lng], 17);
      L.marker([lat,lng]).addTo(map).bindPopup('ç¾åœ¨åœ°');
    }, explainGeoError, { enableHighAccuracy:true, timeout:10000 });

    // ===== capsules render =====
    const markers = {};
    const openedCount = id => new Set(loadOpens().filter(e=>e.capsuleId===id).map(e=>e.userId)).size;
    function capsuleHtml(c){
      const count = openedCount(c.id);
      const safe = (c.text||'ï¼ˆç„¡é¡Œï¼‰').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]));
      return `<div style="min-width:200px">
        <div>ğŸ“¦ ${safe} <small>${c.season||''}</small></div>
        <div style="margin:6px 0;">å—ã‘å–ã£ãŸå›æ•°ï¼š<b>${count}</b></div>
        <div style="display:flex; gap:8px;">
          <button onclick="openFromPopup('${c.id}')">é–‹å°</button>
          <button onclick="reportCapsule('${c.id}')">é€šå ±</button>
        </div>
      </div>`;
    }
    function renderCapsules(){
      const caps=loadCapsules();
      caps.forEach(c=>{
        if(!markers[c.id]){
          markers[c.id]=L.marker([c.lat,c.lng]).addTo(map).bindPopup(capsuleHtml(c));
        }else{
          markers[c.id].setPopupContent(capsuleHtml(c));
        }
      });
    }
    window.openFromPopup=id=>{
      const uid=getUid();
      const opens=loadOpens();
      if(!opens.some(e=>e.capsuleId===id && e.userId===uid)){
        opens.push({capsuleId:id, userId:uid, openedAt:Date.now()});
        saveOpens(opens);
      }
      const c=loadCapsules().find(x=>x.id===id);
      if(c && markers[id]) markers[id].setPopupContent(capsuleHtml(c));
      alert('é–‹å°ã—ã¾ã—ãŸã€‚');
    };
    window.reportCapsule=id=>{
      const reason=prompt('é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰');
      const list=loadReports(); list.push({capsuleId:id, userId:getUid(), reason:reason||'', at:Date.now()});
      saveReports(list); alert('é€šå ±ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ã€‚');
    };
    renderCapsules();

// ===== add capsule (äºŒé‡èµ·å‹•ã‚¬ãƒ¼ãƒ‰ç‰ˆ) =====
{
  const addBtn = document.getElementById('addBtn');
  let adding = false; // å†å…¥é˜²æ­¢

  function reset() {
    adding = false;
    addBtn.disabled = false;
    addBtn.textContent = 'ï¼‹ å®ç®±';
  }

  addBtn.addEventListener('click', (ev) => {
    ev.preventDefault();      // å¿µã®ãŸã‚ submit æŠ‘æ­¢
    ev.stopPropagation();     // è¦ªã¸ã®ãƒãƒ–ãƒªãƒ³ã‚°æŠ‘æ­¢
    if (adding) return;       // äºŒé‡èµ·å‹•ãƒ–ãƒ­ãƒƒã‚¯
    adding = true;
    addBtn.disabled = true;
    addBtn.textContent = 'â€¦ä¿å­˜ä¸­';

    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;

      const text = prompt('å®ç®±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ200å­—ã¾ã§ï¼‰');
      if (text === null) { reset(); return; }
      const str = (text || '').trim();
      if (!str) { alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); reset(); return; }
      if (str.length > 200) { alert('200å­—ä»¥å†…ã§ãŠé¡˜ã„ã—ã¾ã™'); reset(); return; }

      const season = prompt('å­£ç¯€ã‚¿ã‚°ï¼ˆæ˜¥/å¤/ç§‹/å†¬ â€»ä»»æ„ï¼‰') || '';

      const caps = loadCapsules();
      const cap = { id: 'c_' + Date.now(), lat, lng, text: str, season, createdAt: Date.now(), photoUrl: null };
      caps.push(cap); saveCapsules(caps);
      renderCapsules();

      L.popup().setLatLng([lat,lng]).setContent('ğŸ“¦ å®ç®±ã‚’åŸ‹ã‚ã¾ã—ãŸ').openOn(map);
      reset();
    }, err => {
      explainGeoError ? explainGeoError(err) : console.warn(err);
      reset();
    }, { enableHighAccuracy: true, timeout: 10000 });
  }, { passive: false });
}


    // ===== proximity watch =====
    const NEAR_M=60, BUZZ_INTERVAL=60e3;
    let lastBuzzAt=0, lastNearest=null;
    navigator.geolocation.watchPosition(pos=>{
      const me={lat:pos.coords.latitude, lng:pos.coords.longitude};
      const caps=loadCapsules();
      let nearest=null, best=Infinity;
      for(const c of caps){
        const d=distM(me,{lat:c.lat,lng:c.lng});
        if(d<best){best=d; nearest={...c,_dist:d};}
      }
      if(nearest && best<=NEAR_M){
        const now=Date.now(), uid=getUid();
        const already=loadOpens().some(e=>e.capsuleId===nearest.id && e.userId===uid);
        if(!already && now-lastBuzzAt>BUZZ_INTERVAL){
          lastNearest=nearest;
          vibrate([160,80,200]);
          toast(`è¿‘ãã«å®ç®±ãŒã‚ã‚Šã¾ã™ï¼ˆç´„${Math.round(best)}mï¼‰ğŸ“¦  ã‚¿ãƒƒãƒ—ã§é–‹å°`);
          lastBuzzAt=now;
        }
      }
    }, explainGeoError, { enableHighAccuracy:true, maximumAge:5000, timeout:10000 });

    // ãƒˆãƒ¼ã‚¹ãƒˆã‚¿ãƒƒãƒ—ã§é–‹å°
    toastEl.addEventListener('click', ()=>{
      if(!lastNearest) return;
      if(!confirm('è¿‘ãã®å®ç®±ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) return;
      const uid=getUid();
      const opens=loadOpens();
      if(!opens.some(e=>e.capsuleId===lastNearest.id && e.userId===uid)){
        opens.push({capsuleId:lastNearest.id, userId:uid, openedAt:Date.now()});
        saveOpens(opens);
      }
      map.setView([lastNearest.lat,lastNearest.lng], Math.max(map.getZoom(),17));
      if(markers[lastNearest.id]){
        markers[lastNearest.id].setPopupContent(capsuleHtml(lastNearest)).openPopup();
      }else{
        markers[lastNearest.id]=L.marker([lastNearest.lat,lastNearest.lng]).addTo(map)
          .bindPopup(capsuleHtml(lastNearest)).openPopup();
      }
      toastEl.style.display='none';
    });

    // æ¨©é™APIã®ãƒ’ãƒ³ãƒˆï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰
    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({name:'geolocation'}).then(p=>{
        if(p.state==='denied') banner('ä½ç½®æƒ…å ±ãŒãƒ–ãƒ©ã‚¦ã‚¶ã§æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚µã‚¤ãƒˆã®æ¨©é™è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }).catch(()=>{});
    }
  </script>
</body>
</html>
